import { useState } from 'react'
import { Link } from 'react-router-dom'
import DealModal from '../components/deals/DealModal'

interface Deal {
  id: string
  name: string
  value: number
  stage: string
  contact: string
  probability: number
}

const stages = ['Lead', 'Qualified', 'Proposal', 'Negotiation', 'Closed Won', 'Closed Lost']

const initialDeals: Deal[] = [
  { id: '1', name: 'Enterprise Package - Acme Corp', value: 125000, stage: 'Proposal', contact: 'Sarah Johnson', probability: 70 },
  { id: '2', name: 'Premium Subscription - Beta Inc', value: 45000, stage: 'Negotiation', contact: 'Michael Chen', probability: 85 },
  { id: '3', name: 'Starter Plan - Gamma LLC', value: 12000, stage: 'Qualified', contact: 'Emma Davis', probability: 50 },
  { id: '4', name: 'Enterprise Plus - Delta Corp', value: 250000, stage: 'Lead', contact: 'James Wilson', probability: 30 },
  { id: '5', name: 'Professional Package - Echo Ltd', value: 75000, stage: 'Proposal', contact: 'Lisa Brown', probability: 65 },
  { id: '6', name: 'Basic Plan - Foxtrot Inc', value: 8000, stage: 'Closed Won', contact: 'David Lee', probability: 100 },
]

export default function Deals() {
  const [deals, setDeals] = useState<Deal[]>(initialDeals)
  const [viewMode, setViewMode] = useState<'kanban' | 'list'>('kanban')
  const [isModalOpen, setIsModalOpen] = useState(false)
  const [selectedDeal, setSelectedDeal] = useState<Deal | null>(null)

  const getDealsByStage = (stage: string) => {
    return deals.filter((deal) => deal.stage === stage)
  }

  const formatCurrency = (value: number) => {
    return new Intl.NumberFormat('en-US', {
      style: 'currency',
      currency: 'USD',
      minimumFractionDigits: 0,
    }).format(value)
  }

  const handleAddDeal = () => {
    setSelectedDeal(null)
    setIsModalOpen(true)
  }

  const handleSaveDeal = (dealData: Omit<Deal, 'id'> & { id?: string }) => {
    if (dealData.id) {
      // Update existing deal
      setDeals(prev =>
        prev.map(d => (d.id === dealData.id ? { ...dealData, id: dealData.id } : d))
      )
    } else {
      // Add new deal
      const newDeal: Deal = {
        ...dealData,
        id: Date.now().toString(),
      }
      setDeals(prev => [...prev, newDeal])
    }
  }

  return (
    <div className="space-y-6">
      {/* Header */}
      <div className="flex items-center justify-between">
        <div>
          <h1 className="text-5xl font-syne font-bold text-charcoal-900 dark:text-charcoal-50 mb-2">
            Deals Pipeline
          </h1>
          <p className="text-charcoal-600 dark:text-charcoal-400 font-syne-mono text-sm">
            {deals.length} deals â€¢ Total value: {formatCurrency(deals.reduce((sum, d) => sum + d.value, 0))}
          </p>
        </div>
        <div className="flex items-center space-x-3">
          <div className="flex bg-alabaster-300 dark:bg-dark-tertiary rounded-lg p-1">
            <button
              onClick={() => setViewMode('kanban')}
              className={`px-4 py-2 rounded font-syne font-medium text-sm transition-colors ${
                viewMode === 'kanban' ? 'bg-white dark:bg-dark-secondary shadow-sm text-charcoal-900 dark:text-charcoal-50' : 'text-charcoal-600 dark:text-charcoal-400'
              }`}
            >
              Kanban
            </button>
            <button
              onClick={() => setViewMode('list')}
              className={`px-4 py-2 rounded font-syne font-medium text-sm transition-colors ${
                viewMode === 'list' ? 'bg-white dark:bg-dark-secondary shadow-sm text-charcoal-900 dark:text-charcoal-50' : 'text-charcoal-600 dark:text-charcoal-400'
              }`}
            >
              List
            </button>
          </div>
          <button onClick={handleAddDeal} className="btn btn-primary">
            + New Deal
          </button>
        </div>
      </div>

      {viewMode === 'kanban' ? (
        /* Kanban View */
        <div className="flex space-x-4 overflow-x-auto pb-4">
          {stages.map((stage) => {
            const deals = getDealsByStage(stage)
            const stageValue = deals.reduce((sum, d) => sum + d.value, 0)

            return (
              <div key={stage} className="flex-shrink-0 w-80">
                <div className="bg-alabaster-300 dark:bg-dark-tertiary rounded-lg p-4">
                  <div className="flex items-center justify-between mb-4">
                    <h3 className="font-syne font-normal text-charcoal-900 dark:text-charcoal-50">
                      {stage}
                      <span className="ml-2 text-sm font-syne-mono text-charcoal-600 dark:text-charcoal-400">({deals.length})</span>
                    </h3>
                    <span className="text-sm font-syne-mono font-medium text-charcoal-600 dark:text-charcoal-400">
                      {formatCurrency(stageValue)}
                    </span>
                  </div>

                  <div className="space-y-3">
                    {deals.map((deal) => (
                      <Link
                        key={deal.id}
                        to={`/deals/${deal.id}`}
                        className="block bg-white dark:bg-dark-secondary rounded-lg p-4 border border-alabaster-600/50 dark:border-dark-border cursor-pointer transition-all duration-300 ease-out hover:-translate-y-2 hover:shadow-2xl"
                        style={{boxShadow: '0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06)'}}
                      >
                        <h4 className="font-syne font-medium text-charcoal-900 dark:text-charcoal-50 mb-2">{deal.name}</h4>
                        <div className="flex items-center justify-between text-sm">
                          <span className="font-syne-mono font-bold text-charcoal-900 dark:text-charcoal-50">{formatCurrency(deal.value)}</span>
                          <span className="font-syne-mono text-charcoal-600 dark:text-charcoal-400">{deal.probability}%</span>
                        </div>
                        <p className="text-xs font-syne-mono text-charcoal-600 dark:text-charcoal-400 mt-2">{deal.contact}</p>
                      </Link>
                    ))}

                    {deals.length === 0 && (
                      <div className="text-center py-8 text-charcoal-500 dark:text-charcoal-400 text-sm font-syne-mono">
                        No deals in this stage
                      </div>
                    )}
                  </div>
                </div>
              </div>
            )
          })}
        </div>
      ) : (
        /* List View */
        <div className="floating-box overflow-hidden">
          <table className="min-w-full divide-y divide-alabaster-600/30 dark:divide-dark-border">
            <thead className="bg-alabaster-200 dark:bg-dark-tertiary">
              <tr>
                <th className="px-6 py-3 text-left text-xs font-syne font-bold text-charcoal-800 dark:text-charcoal-200 uppercase tracking-wider">
                  Deal Name
                </th>
                <th className="px-6 py-3 text-left text-xs font-syne font-bold text-charcoal-800 dark:text-charcoal-200 uppercase tracking-wider">
                  Contact
                </th>
                <th className="px-6 py-3 text-left text-xs font-syne font-bold text-charcoal-800 dark:text-charcoal-200 uppercase tracking-wider">
                  Value
                </th>
                <th className="px-6 py-3 text-left text-xs font-syne font-bold text-charcoal-800 dark:text-charcoal-200 uppercase tracking-wider">
                  Stage
                </th>
                <th className="px-6 py-3 text-left text-xs font-syne font-bold text-charcoal-800 dark:text-charcoal-200 uppercase tracking-wider">
                  Probability
                </th>
                <th className="px-6 py-3 text-right text-xs font-syne font-bold text-charcoal-800 dark:text-charcoal-200 uppercase tracking-wider">
                  Actions
                </th>
              </tr>
            </thead>
            <tbody className="bg-white dark:bg-dark-secondary divide-y divide-alabaster-600/30 dark:divide-dark-border">
              {deals.map((deal) => (
                <tr key={deal.id} className="hover:bg-alabaster-100 dark:hover:bg-dark-hover transition-colors">
                  <td className="px-6 py-4">
                    <Link
                      to={`/deals/${deal.id}`}
                      className="font-syne font-medium text-charcoal-900 dark:text-charcoal-50 hover:text-charcoal-700 dark:hover:text-charcoal-300 transition-colors"
                    >
                      {deal.name}
                    </Link>
                  </td>
                  <td className="px-6 py-4 text-sm font-syne-mono text-charcoal-600 dark:text-charcoal-400">{deal.contact}</td>
                  <td className="px-6 py-4 text-sm font-syne-mono font-semibold text-charcoal-900 dark:text-charcoal-50">
                    {formatCurrency(deal.value)}
                  </td>
                  <td className="px-6 py-4">
                    <span className="badge badge-info">
                      {deal.stage}
                    </span>
                  </td>
                  <td className="px-6 py-4 text-sm font-syne-mono text-charcoal-600 dark:text-charcoal-400">{deal.probability}%</td>
                  <td className="px-6 py-4 text-right text-sm">
                    <button className="text-charcoal-900 dark:text-charcoal-300 hover:text-charcoal-700 dark:hover:text-charcoal-100 font-syne font-semibold mr-3 transition-colors">Edit</button>
                    <button className="text-danger-600 dark:text-danger-400 hover:text-danger-800 dark:hover:text-danger-300 font-syne font-semibold transition-colors">Delete</button>
                  </td>
                </tr>
              ))}
            </tbody>
          </table>
        </div>
      )}

      {/* Deal Modal */}
      <DealModal
        isOpen={isModalOpen}
        onClose={() => setIsModalOpen(false)}
        onSave={handleSaveDeal}
        deal={selectedDeal}
      />
    </div>
  )
}
