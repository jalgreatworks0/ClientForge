# DB-001: PostgresUnavailable

**Severity**: Critical
**HTTP Status**: 503
**Retry Strategy**: Safe
**Notify**: Yes

## Description

PostgreSQL database is unavailable or unreachable. This is a critical infrastructure failure that affects all database operations.

## Impact

- All API endpoints requiring database access will fail
- User authentication will fail
- Data writes and reads are blocked
- System is effectively down

## Detection

### Signals
- Port 5432 unreachable
- Connection refused errors in logs
- Health check endpoint returns unhealthy
- Prometheus alert: `postgres_up == 0`

### Log Pattern
```
logger.error("[ERROR]", {
  id: "DB-001",
  name: "PostgresUnavailable",
  severity: "critical"
})
```

### Grafana Dashboard
- **Dashboard**: DB Health
- **Panel**: PostgreSQL Connection Status
- **Alert**: PostgreSQL Down

## Immediate Actions

### 1. Verify Service Status
```bash
# Check if Docker container is running
docker ps | grep postgres

# Check container logs
docker logs clientforge-crm-postgres-1

# Check connection
psql -h localhost -p 5432 -U postgres -c "SELECT 1;"
```

### 2. Check Resource Usage
```bash
# Check disk space
df -h

# Check memory
free -h

# Check Docker resources
docker stats
```

### 3. Review Recent Changes
- Check if any deployments happened in last 30 minutes
- Review recent database migrations
- Check if backup/restore operations are running

## Troubleshooting Steps

### Step 1: Restart PostgreSQL Container
```bash
cd /path/to/clientforge-crm
docker-compose restart postgres

# Wait 10 seconds
sleep 10

# Verify connection
npm run db:check-extensions
```

### Step 2: Check Database Logs
```bash
docker logs clientforge-crm-postgres-1 --tail 100

# Look for:
# - Out of memory errors
# - Disk full errors
# - Corruption warnings
# - Failed authentication
```

### Step 3: Verify Configuration
```bash
# Check .env file
cat backend/.env | grep DATABASE_URL

# Verify docker-compose.yml
cat docker-compose.yml | grep -A 10 postgres
```

### Step 4: Test Connection Manually
```bash
# From host
psql postgresql://postgres:postgres@localhost:5432/clientforge_dev

# From inside container
docker exec -it clientforge-crm-postgres-1 psql -U postgres -d clientforge_dev
```

## Resolution Steps

### Option 1: Service Restart (Quickest)
```bash
docker-compose restart postgres
```
**Expected Time**: 10-30 seconds

### Option 2: Full Docker Compose Restart
```bash
docker-compose down
docker-compose up -d
```
**Expected Time**: 1-2 minutes

### Option 3: Restore from Backup
If database is corrupted:
```bash
npm run db:restore
npm run db:migrate
```
**Expected Time**: 5-15 minutes

## Prevention

1. **Monitoring**: Ensure Prometheus alerts are configured
2. **Health Checks**: Docker health checks every 30s
3. **Backups**: Automated daily backups at 2 AM UTC
4. **Resource Limits**: Set memory limits in docker-compose.yml
5. **Connection Pooling**: Max 20 connections per service

## Related Errors

- **DB-002**: MongoWriteFailed
- **DB-003**: MongoConnectionFailed
- **DB-004**: QueryTimeout

## Escalation

### Level 1 (0-5 minutes)
- On-call engineer investigates
- Check monitoring dashboards
- Attempt service restart

### Level 2 (5-15 minutes)
- Senior DevOps engineer paged
- Consider failover to replica
- Investigate root cause

### Level 3 (15+ minutes)
- CTO notified
- Customer communication initiated
- Consider disaster recovery procedures

## Post-Incident

1. **Root Cause Analysis**: Document what caused the outage
2. **Incident Report**: File in `docs/incidents/YYYY-MM-DD-db-outage.md`
3. **Lessons Learned**: Update runbook with new information
4. **Prevention**: Implement safeguards to prevent recurrence

## References

- [PostgreSQL Docker Documentation](https://hub.docker.com/_/postgres)
- [Docker Compose Documentation](https://docs.docker.com/compose/)
- [ClientForge DB Setup Guide](docs/database/README.md)

---

**Last Updated**: 2025-11-11
**Runbook Version**: 1.0
**Owner**: DevOps Team
