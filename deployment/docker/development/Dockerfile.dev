FROM node:22-alpine
WORKDIR /app

# system deps
RUN apk add --no-cache tini curl

ENTRYPOINT ["/sbin/tini","--"]

# copy only manifests to leverage docker layer cache
COPY package.json package-lock.json* ./

# install dependencies
RUN npm ci || true

# back to repo root and copy source
COPY . .

# logs directory for promtail file scraping
RUN mkdir -p /app/logs
VOLUME ["/app/logs"]

# Change to backend directory for path resolution
WORKDIR /app/backend

ENV NODE_ENV=development
ENV PORT=3000
EXPOSE 3000

# Use dev script with ts-node-dev for development
CMD ["npm","run","--prefix","/app","dev:backend"]
