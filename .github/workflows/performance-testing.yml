name: Performance Testing

on:
  schedule:
    # Run weekly on Sunday at 3 AM UTC
    - cron: '0 3 * * 0'
  push:
    branches: [main]
    paths:
      - 'backend/**'
      - 'frontend/**'
  workflow_dispatch:

jobs:
  # =============================================================================
  # LOAD TESTING
  # =============================================================================
  load-test:
    name: Load Testing with k6
    runs-on: ubuntu-latest
    timeout-minutes: 30

    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: clientforge_perf
        ports:
          - 5432:5432

      redis:
        image: redis:7
        ports:
          - 6379:6379

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18.x'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build application
        run: npm run build

      - name: Start application
        run: |
          npm run start:perf &
          npx wait-on http://localhost:3000/api/v1/health -t 60000

      - name: Install k6
        run: |
          curl https://github.com/grafana/k6/releases/download/v0.47.0/k6-v0.47.0-linux-amd64.tar.gz -L | tar xvz --strip-components 1
          sudo mv k6 /usr/local/bin/

      - name: Run k6 load tests
        run: k6 run tests/performance/load-test.js --out json=load-test-results.json

      - name: Upload k6 results
        uses: actions/upload-artifact@v3
        with:
          name: load-test-results
          path: load-test-results.json

      - name: Parse results and fail if thresholds exceeded
        run: node tests/performance/parse-k6-results.js

  # =============================================================================
  # LIGHTHOUSE PERFORMANCE
  # =============================================================================
  lighthouse:
    name: Lighthouse Performance Audit
    runs-on: ubuntu-latest
    timeout-minutes: 20

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18.x'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build frontend
        run: npm run build:frontend

      - name: Start application
        run: |
          npm run start:prod &
          npx wait-on http://localhost:3000 -t 60000

      - name: Run Lighthouse CI
        uses: treosh/lighthouse-ci-action@v10
        with:
          urls: |
            http://localhost:3000
            http://localhost:3000/dashboard
            http://localhost:3000/contacts
          uploadArtifacts: true
          temporaryPublicStorage: true

  # =============================================================================
  # BUNDLE SIZE ANALYSIS
  # =============================================================================
  bundle-analysis:
    name: Bundle Size Analysis
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18.x'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build with bundle analysis
        run: npm run build:analyze

      - name: Upload bundle analysis
        uses: actions/upload-artifact@v3
        with:
          name: bundle-analysis
          path: |
            dist/bundle-report.html
            dist/bundle-stats.json

      - name: Check bundle size
        uses: andresz1/size-limit-action@v1
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          skip_step: install

  # =============================================================================
  # DATABASE PERFORMANCE
  # =============================================================================
  db-performance:
    name: Database Query Performance
    runs-on: ubuntu-latest
    timeout-minutes: 20

    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: clientforge_perf
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    env:
      DATABASE_URL: postgresql://postgres:postgres@localhost:5432/clientforge_perf

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18.x'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run migrations
        run: npm run migrate

      - name: Seed test data
        run: npm run seed:perf

      - name: Enable query logging
        run: |
          psql $DATABASE_URL -c "ALTER SYSTEM SET log_statement = 'all';"
          psql $DATABASE_URL -c "ALTER SYSTEM SET log_min_duration_statement = 100;"
          psql $DATABASE_URL -c "SELECT pg_reload_conf();"

      - name: Run query performance tests
        run: npm run test:db-perf

      - name: Analyze slow queries
        run: |
          psql $DATABASE_URL -c "
            SELECT query, calls, total_time, mean_time, max_time
            FROM pg_stat_statements
            ORDER BY mean_time DESC
            LIMIT 20;" > slow-queries.txt

      - name: Upload slow query report
        uses: actions/upload-artifact@v3
        with:
          name: slow-queries
          path: slow-queries.txt

  # =============================================================================
  # NOTIFICATION
  # =============================================================================
  notify:
    name: Performance Report
    runs-on: ubuntu-latest
    needs: [load-test, lighthouse, bundle-analysis, db-performance]
    if: always()

    steps:
      - name: Send performance report
        uses: 8398a7/action-slack@v3
        with:
          status: custom
          custom_payload: |
            {
              text: "Performance Testing Completed",
              attachments: [{
                color: '${{ needs.load-test.result }}' === 'success' ? 'good' : 'warning',
                fields: [
                  { title: 'Load Test', value: '${{ needs.load-test.result }}', short: true },
                  { title: 'Lighthouse', value: '${{ needs.lighthouse.result }}', short: true },
                  { title: 'Bundle Size', value: '${{ needs.bundle-analysis.result }}', short: true },
                  { title: 'DB Performance', value: '${{ needs.db-performance.result }}', short: true }
                ]
              }]
            }
          webhook_url: ${{ secrets.SLACK_PERFORMANCE_WEBHOOK }}
